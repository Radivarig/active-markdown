<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <style>
        blockquote {
    border-left: 3px solid #ccc;
    font-style: italic;
    padding-left: 1em;
    margin-left: 0;
}
pre {
    color: #444;
    background: #fbfbfb;
    padding: 1em;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow: scroll;
}
body {
    max-width: 690px;
    margin: 0 auto;
    padding: 2em 1em;
    font-family: Georgia;
    background: #fdfdfd;
    color: #0e0e0e;
}
p, blockquote {
    line-height: 1.5;
}
hr {
    border: 0;
    border-bottom: 1px solid #ccc;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
}
.Variable {
    border: 1px solid rgba(0,0,255,0.8);
    padding: 0.1em;
    position: relative;
    border-radius: 3px;
}
.Variable .variable-label {
    font-size: 0.8em;
    background-color: yellow;
    border: 1px dotted #ccc;
    font-family: Menlo, Courier New, monospace;
}
.Variable .variable-label:before {
    content: "@";
}
.Variable.readonly {
    border-color: rgba(0,0,255,0.2);
}
.NumberVar .slider {
    width: 200px;
    position: absolute;
    bottom: 100%;
    left: -25px;
    display: none;
}
.NumberVar:hover .slider, .NumberVar:active .slider  {
    display: block;
}
.BinaryVar label, .BinaryVar input {
    cursor: pointer;
}
.GraphView {
    margin: 1em 0;
}
.GraphView .graph-title {
    text-align: center;
    font-weight: bold;
}
.GraphView .graph-canvas {
    width: 100%;
}

#raw {
    font-family: Menlo;
    white-space: pre;
    border-bottom: 1px solid #ccc;
    max-height: 0;
    overflow: hidden;
    -webkit-transition-property: max-height;
    -webkit-transition-duration: 0.5s;
}
#raw.visible {
    max-height: 10000px;
}
    </style>
</head>
<body>
    <div id="content"><h1>St Ives</h1>
<p>An old riddle.</p>
<blockquote>
<p>As <span class="live-text"  data-name="travelers" data-config='["I", "or", "we"]'>I</span> <span class="live-text"  data-name="verb" data-config='[]'>was</span> going to <strong>St Ives</strong><br />
I met a man with <span class="live-text"  data-name="wives" data-config='["[1...10]"]'>7</span> wives<br />
Every wife had <span class="live-text"  data-name="sacks" data-config='["[1...10]"]'>7</span> sacks<br />
Every sack had <span class="live-text"  data-name="cats" data-config='["[1...10]"]'>7</span> cats<br />
Every cat had <span class="live-text"  data-name="kits" data-config='["[1...10]"]'>7</span> kits<br />
Kits, cats, sacks, wives  </p>
</blockquote>
<pre><code>total_sacks     = @wives * @sacks
total_cats      = total_sacks * @cats
total_kits      = total_cats * @kits
narrator        = 1
man             = 1
@first_guess = man + @wives + total_cats + total_kits + narrator
</code></pre>
<blockquote>
<p>How many were going to St Ives?</p>
</blockquote>
<pre><code>if @travelers is 'I'
    @answer = 1
    @verb = 'was'
else
    @answer = 2
    @verb = 'were'
</code></pre>
<p>The first guess is often <span class="live-text"  data-name="first_guess" data-config='[]'>2753</span>, but the answer is <span class="live-text"  data-name="answer" data-config='[]'>1</span></p>
<hr />
<p>(This file is an example of <a href="https://github.com/alecperkins/active-markdown">Active Markdown</a>. See the <a href="st-ives.amd">plaintext source</a>.)</p></div>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
    <link href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.string/2.3.0/underscore.string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.10/backbone-min.js"></script>
    <script src="https://raw.github.com/alecperkins/Backbone.NamedView/master/backbone.namedview.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/coffee-script/1.4.0/coffee-script.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.7/jquery.flot.min.js"></script>
    <script>// Generated by CoffeeScript 1.6.1
(function() {
  var BinaryVar, Executor, GraphView, NumberVar, StringVar, Variable, buildBinaryVar, buildGraph, buildNumberVar, buildStringVar, executor, makeLive,
    _this = this,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  _.templateSettings = {
    interpolate: /\{\{(.+?)\}\}/g,
    evaluate: /\{\%(.+?)\%\}/g
  };

  Executor = (function() {

    function Executor() {
      var _this = this;
      this._deferredExecute = function() {
        return Executor.prototype._deferredExecute.apply(_this, arguments);
      };
      this._variables = {};
      $('pre code').on('blur', this._deferredExecute);
    }

    Executor.prototype.getOrCreateVariable = function(attrs) {
      var name, variable_model;
      name = attrs.name;
      if (this._variables[name]) {
        variable_model = this._variables[name];
        delete attrs.value;
      } else {
        variable_model = new Backbone.Model(name);
        this._variables[name] = variable_model;
        variable_model.on('change', this._deferredExecute);
      }
      variable_model.set(attrs);
      return variable_model;
    };

    Executor.prototype._prepareState = function() {
      var state;
      state = {};
      _.each(this._variables, function(v) {
        return state[v.get('name')] = v.get('value');
      });
      return state;
    };

    Executor.prototype._compileCode = function() {
      var coffee_code_str, js_code_str;
      coffee_code_str = '';
      $('pre code').each(function(i, el) {
        return coffee_code_str += $(el).text();
      });
      js_code_str = CoffeeScript.compile(coffee_code_str);
      return js_code_str;
    };

    Executor.prototype._deferredExecute = function() {
      var _this = this;
      if (!this._is_executing) {
        this._is_executing = true;
        return _.defer(function() {
          var fn, js_code_str, state;
          state = _this._prepareState();
          js_code_str = _this._compileCode();
          fn = Function(js_code_str);
          fn.call(state, js_code_str);
          _this._updateVariablesFrom(state);
          return _this._is_executing = false;
        });
      }
    };

    Executor.prototype._updateVariablesFrom = function(state) {
      var k, v, _ref, _results;
      _results = [];
      for (k in state) {
        v = state[k];
        _results.push((_ref = this._variables[k]) != null ? _ref.set({
          value: v
        }) : void 0);
      }
      return _results;
    };

    return Executor;

  })();

  executor = new Executor();

  makeLive = function(i, el) {
    var $tag, config, live_element, name, text_content;
    $tag = $(el);
    name = $tag.data('name');
    config = $tag.data('config');
    text_content = $tag.html();
    if ($tag.data('graph')) {
      live_element = buildGraph(text_content, name, config);
    } else if (config.length === 3 && config[1] === 'or') {
      live_element = buildBinaryVar(text_content, name, config);
    } else if (/[[\d]+[\.]{2,3}[\d]+]/.test(config[0])) {
      live_element = buildNumberVar(text_content, name, config);
    } else {
      live_element = buildStringVar(text_content, name, config);
    }
    return $tag.replaceWith(live_element.render());
  };

  Variable = (function(_super) {

    __extends(Variable, _super);

    function Variable() {
      var _this = this;
      this.render = function() {
        return Variable.prototype.render.apply(_this, arguments);
      };
      return Variable.__super__.constructor.apply(this, arguments);
    }

    Variable.prototype.tagName = 'span';

    Variable.prototype.initialize = function() {
      this.listenTo(this.model, 'change', this.render);
      return this._ui_map = _.extend({}, this.ui);
    };

    Variable.prototype.render = function() {
      var _this = this;
      this.ui = {};
      if (this.readonly) {
        this.$el.addClass('readonly');
      }
      _.defer(function() {
        var name, selector, _ref;
        _this.$el.html(_.template(_this.template)(_this.model.toJSON()));
        _ref = _this.ui_map;
        for (name in _ref) {
          selector = _ref[name];
          _this.ui[name] = _this.$el.find(selector);
        }
        return _this.onRender();
      });
      return this.el;
    };

    Variable.prototype.onRender = function() {};

    return Variable;

  })(Backbone.NamedView);

  NumberVar = (function(_super) {

    __extends(NumberVar, _super);

    function NumberVar() {
      var _this = this;
      this._update = function(e, ui) {
        return NumberVar.prototype._update.apply(_this, arguments);
      };
      return NumberVar.__super__.constructor.apply(this, arguments);
    }

    NumberVar.prototype.ui_map = {
      slider: 'span.slider',
      output: 'span.output'
    };

    NumberVar.prototype._update = function(e, ui) {
      return this.model.set({
        value: parseInt(ui.value)
      });
    };

    NumberVar.prototype.template = "<span class=\"variable-label\">{{ name }}</span>\n<span class=\"slider\"></span>\n<span class=\"output\">{{ value }}</span>";

    NumberVar.prototype.onRender = function() {
      var _this = this;
      return this.ui.slider.slider({
        min: this.model.get('min'),
        max: this.model.get('max'),
        value: this.model.get('value'),
        change: this._update,
        slide: function(e, ui) {
          return _this.ui.output.text(ui.value);
        }
      });
    };

    return NumberVar;

  })(Variable);

  buildNumberVar = function(text_content, name, config) {
    var max, min, number_model, variable_view;
    config = _.string.strip(config[0], '][').split('.');
    min = _.first(config);
    max = _.last(config);
    text_content = _.string.strip(text_content, '$%');
    number_model = executor.getOrCreateVariable({
      name: name,
      min: parseInt(min),
      max: parseInt(max),
      value: parseInt(text_content)
    });
    variable_view = new NumberVar({
      model: number_model
    });
    return variable_view;
  };

  BinaryVar = (function(_super) {

    __extends(BinaryVar, _super);

    function BinaryVar() {
      return BinaryVar.__super__.constructor.apply(this, arguments);
    }

    BinaryVar.prototype.template = "<span class=\"variable-label\">{{ name }}</span>\n<label><input class=\"option-a\" name=\"{{ name }}\" type=\"radio\" value=\"{{ a }}\">{{ a }}</label>\n<label><input class=\"option-b\" name=\"{{ name }}\" type=\"radio\" value=\"{{ b }}\">{{ b }}</label>";

    BinaryVar.prototype.onRender = function() {
      var a, b, value, _ref;
      _ref = this.model.toJSON(), value = _ref.value, a = _ref.a, b = _ref.b;
      if (value === a) {
        return this.$el.find('.option-a').attr('checked', true);
      } else if (value === b) {
        return this.$el.find('.option-b').attr('checked', true);
      }
    };

    BinaryVar.prototype.events = {
      'change input': '_update'
    };

    BinaryVar.prototype.ui_map = {
      'a': '.option-a',
      'b': '.option-b'
    };

    BinaryVar.prototype._update = function() {
      if (this.ui.a.is(':checked')) {
        return this.model.set('value', this.ui.a.val());
      } else if (this.ui.b.is(':checked')) {
        return this.model.set('value', this.ui.b.val());
      }
    };

    return BinaryVar;

  })(Variable);

  buildBinaryVar = function(text_content, name, config) {
    var var_model, variable_view;
    var_model = executor.getOrCreateVariable({
      name: name,
      value: text_content,
      a: config[0],
      b: config[2]
    });
    variable_view = new BinaryVar({
      model: var_model
    });
    return variable_view;
  };

  StringVar = (function(_super) {

    __extends(StringVar, _super);

    function StringVar() {
      return StringVar.__super__.constructor.apply(this, arguments);
    }

    StringVar.prototype.readonly = true;

    StringVar.prototype.template = "<span class=\"variable-label\">{{ name }}</span>\n{% if(value.toFixed) { %}\n    {{ value.toFixed(1) }}\n{% } else { %}\n    {{ value }}\n{% } %}";

    return StringVar;

  })(Variable);

  buildStringVar = function(text_content, name, config) {
    var var_model, variable_view;
    var_model = executor.getOrCreateVariable({
      name: name,
      value: text_content
    });
    variable_view = new StringVar({
      model: var_model
    });
    return variable_view;
  };

  GraphView = (function(_super) {

    __extends(GraphView, _super);

    function GraphView() {
      return GraphView.__super__.constructor.apply(this, arguments);
    }

    GraphView.prototype.readonly = true;

    GraphView.prototype.tagName = 'div';

    GraphView.prototype.template = "<div class=\"graph-title\">{{ title }}</div>\n<div class=\"graph-canvas\"></div>";

    GraphView.prototype.ui_map = {
      'canvas': '.graph-canvas'
    };

    GraphView.prototype.onRender = function() {
      this.ui.canvas.css({
        height: this.ui.canvas.width() / 2
      });
      return this._generateGraph();
    };

    GraphView.prototype._generateGraph = function() {
      var config, end, graphFn, series, start, x, x_range, _i;
      config = this.model.get('config');
      x_range = config[0].split('=')[1];
      x_range = _.string.strip(x_range, '[]').split('.');
      start = parseInt(_.first(x_range));
      end = parseInt(_.last(x_range));
      series = [];
      graphFn = this.model.get('value');
      for (x = _i = start; 0.1 > 0 ? _i < end : _i > end; x = _i += 0.1) {
        series.push([x, graphFn(x)]);
      }
      return $.plot(this.ui.canvas, [series]);
    };

    return GraphView;

  })(Variable);

  buildGraph = function(text_content, name, config) {
    var graph_view, var_model;
    var_model = executor.getOrCreateVariable({
      name: name,
      title: text_content,
      config: config
    });
    graph_view = new GraphView({
      model: var_model
    });
    return graph_view;
  };

  $('.live-text').each(makeLive);

  $('pre code').each(function(i, code) {
    return $(code).attr('contenteditable', true);
  });

}).call(this);
</script>
</body>
</html>